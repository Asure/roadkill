**
** SETCARPARTS
**
**  MEANT TO BE CALLED AFTER CALL TO CARILIST
** IN
**  A0 SCRATCH
**  A1 PTR IMGTBL SHADOW
**  A2 DMACTRL
**  A3 PTR TO IMGLIST CHASIS
**  A4 SCRATCH
**  A5 SCRATCH
**  A8 OBJ
**
** JFL 03 AUG 92
** JFL 04 AUG 92
** JFL 07 AUG 92; TREAT HEAD (CHASIS) DIFFERENT
** JFL 09 SEP 92
** JFL 13 SEP 92; SCALE FIX
** JFL 28 SEP 92; NEW SCRATCH
** JFL 18 OCT 92; 1 PART CARS
** JFL 29 DEC 92
**
SETCARPARTS
	MOVE	A2,A4			;A4 CTRL
	MOVE	A3,A2			;A2 ILIST

	;
	;HANDLE SHADOW
	;
	MOVL	*A8(OSHADIMG),A0
	JRZ	SCPNOSHAD

	;UPDATE OBJECT IMG
	MOVE	A1,A3
	MOVL	*A3+,A1				;GET SHAD IMG
	JRNZ	SCPSHADOK
	JRUC	SCPNOSHAD
SCPSHADOK
	MOVW	*A3,A5				;GET FLIP & DMACNZ CTRL
	MOVW	*A1(ICTRL),A14			
	OR	A14,A5
  	MOVW	A5,*A0(OCTRL)
	MOVL	A1,*A0(OIMG)			;UPDATE IMAGE
	MOVL	*A1(ISIZE),A14			;Y:X SIZ
	MOVL	A14,*A0(OSIZE)
	MOVL	A14,*A0(OUSIZE)
	MOVL	*A1(IANIOFF),A14		;Y:X ANI
	MOVL	A14,*A0(OANIOFF)
	MOVL	A14,*A0(OUANIOFF)
 	MOVL	*A1(ISAG),*A0(OSAG)		;SAG

	CLR	A14
	MOVW	A14,*A0(OSCALEMUL)		;FORCE UPDATE

SCPNOSHAD
	
	;
	;CONTINUE WITH CAR PARTS
	;
       	MOVE	A8,A0
	MOVW	*A0(OPARTID),A3		;HEAD HAS NUM PARTS

SCPLOOP
	MOVL	*A2+,A1			;NEXT IMG IN TABLE
	MOVW	*A0(OPARTID),A14	;ONLY SET CAR PARTS
	CMP	A3,A14
	JRNE	SCPNEXT

	MOVW	*A0(OFLAGS),A5		;OFLAGS

	;HANDLE A NON DISPLAYABLE PART
	MOVE	A1,A1
	JRNZ	SCPREAL

	;DONT DISPLAY THE OBJ
	SETF	1,0,0
	MOVE	SP,*A0(OCTRL+B_INUSE),0
	SETF	16,1,0
	JRUC	SCPNPART

SCPREAL
	;UPDATE OBJECT IMG
	MOVL	A1,*A0(OIMG)			;UPDATE IMAGE
	MOVL	*A1(ISIZE),A14			;Y:X SIZ
	MOVL	A14,*A0(OSIZE)
	MOVL	A14,*A0(OUSIZE)
	MOVL	*A1(IANIOFF),A14		;Y:X ANI
	MOVL	A14,*A0(OANIOFF)
	MOVL	A14,*A0(OUANIOFF)
 	MOVL	*A1(ISAG),*A0(OSAG)		;SAG
  	MOVW	*A1(ICTRL),A14			;GET ICTRL
	OR	A4,A14				;OR IN OUR
  	MOVW	A14,*A0(OCTRL)

	CLR	A14
	MOVW	A14,*A0(OSCALEMUL)		;FORCE UPDATE

SCPNPART
	MOVW	A5,*A0(OFLAGS)
	MOVL	*A0(OPARTS),A0			;NEXT OBJ PART
	JRZ	SCPX	 			;NO MORE PARTS
SCPNEXT
	DEC	A3
	JRP	SCPLOOP
SCPX
	;GO BACK AND GIVE HEAD A SCALE
	CALLR	SETOBJSCALE ;IN: A8 OBJ

	RETS

**
** SETZCARPARTS
** THIS IS NECESSARY BECAUSE VELADD MAY MAX OUT PIECE COORDS TO THE
** SAME VALUES AS THE HEAD OBJ
**
**  A8 OBJ
** SCRATCHES A0
**
** JFL 14 SEP 92
** JFL 28 SEP 92; NEW SCRATCH
** JFL 18 OCT 92; 1 PART CARS
**
SETZCARPARTS
       	MOVE	A8,A0
	MOVW	*A0(OPARTID),A3		;HEAD HAS NUM PARTS
	JRZ	SZCPX
	MOVL	*A0(OZVAL),A2
	INC	A2			;MAKE PARTS CLOSER
	JRUC	SZCPNPART		;SKIP HEAD

SZCPLOOP
	MOVW	*A0(OPARTID),A14	;ONLY SET CAR PARTS
	CMP	A3,A14
	JRNE	SZCPNEXT

	;CHANGE Z OF ALL PARTS
	MOVL	A2,*A0(OZVAL)

SZCPNPART
	MOVL	*A0(OPARTS),A0			;NEXT OBJ PART
	JRZ	SZCPX	 			;NO MORE PARTS
SZCPNEXT
	DSJ	A3,SZCPLOOP 			;CAR PARTS MUST BE FIRST PARTS
SZCPX
	RETS

**
** CHECKFORNSPART
** CHECK ALL PARTS FOR THE ID
**
**  A0 OBJ HEAD
**  A1 NS PART ID
** RETURNS NZ IF ALREADY HAS ONE, Z IF NOT YET
**
** JFL 26 AUG 92
**
CHECKFORNSPART
	MMTM	SP,A0
CFNSPLOOP
	MOVE	*A0(OPARTS),A0,L	
	JRZ	CFNSPX
	MOVE	*A0(OPARTID),A14,W
	CMP	A1,A14
	JRNE	CFNSPLOOP
CFNSPX
	MOVE	A0,A0		;SET NZ OR Z
	MMFM	SP,A0
	RETS

**
** SETNONSTANDARDPARTS
** MOVE ANIM POINTS ON MULTIPART OBJECTS FOR NONSTANDARD PARTS
**
**  A8 OBJ
**
** JFL 23 AUG 92
** JFL 24 AUG 92
** JFL 28 SEP 92; NEW SCRATCH
**
SETNONSTANDARDPARTS
	MOVE	A8,A0

	.IF DEBUG
	MOVL	*A8(OPART1),A14
	JRZ	SNSPXXX
	CMP	A14,A8
	TLOCKON	NE
SNSPXXX
	.ENDIF ;DEBUG

SNSPLOOP
	MOVL	*A0(OPARTS),A0
	JRZ	SNSPX
	
	;CHECK PART NUMBER
	MOVW	*A0(OPARTID),A1
	JRN	SNSPLOOP
	CMPI	FIRSTNSPART,A1
	JRLT	SNSPLOOP

	CALLR	SETNSPONE ;IN: A0,A1,A8 OBJPART,OPARTID,OBJHEAD

	JRUC	SNSPLOOP

SNSPX
	RETS


**
** SETNSPONE
**
** IN
**   A0 OBJ PART
**   A1 OPARTID 
**   A2-A3 SCRATCH
**   A8 OBJ HEAD
**
** JFL 24 AUG 92 
** JFL 26 AUG 92 
** JFL 28 SEP 92; NEW SCRATCH
** JFL 12 OCT 92; OPARTSXY
** JFL 09 NOV 92; NEW PTS
** JFL 12 NOV 92; IPTS
** JFL 12 JAN 93
**
SETNSPONE
	.IF DEBUG
	CMP	A0,A8
	TLOCKON	EQ		;SCALE SETTINGS ASSUME PART NOT HEAD
	.ENDIF ;DEBUG

	;GET PART INDEX
	SUBI	FIRSTNSPART,A1	;GET INDEX INTO LIST
	TLOCKON	N

	;CHECK IF THIS PART GOES ON WHEEL
	CMPI	FIRSTNSNONWHEEL-FIRSTNSPART,A1
	JRGE	SNSPNWHEEL

	;GET IMAGE LIST FOR THIS DIR
	MOVL	*A8(OCAR),A3
	MOVL	*A3(CDS0ILIST),A3
	MOVB	*A8(ODIR),A2
	SLL	24,A2			;CLEAN OFF SIGN SHIT
	SRL	24+SR_DIR2CAR,A2	;CLEAN BOTTOM
	SLL	SL_CAR2OFF,A2		;ENTRY SIZE
	ADD	A3,A2

	;GET IMG HEADER & CTRL BITS
	MOVL	*A2+,A3			;MULTI IMG BLOCK
	MOVL	*A3,A3			;IHDR
	
	;TEST IF THIS IS HFLIPPED
	MOVB	*A2(B_FLIPH-7),A14
	JRN	SNSPHFLIP

	;GET ANIM POINT CORRESPONDING TO NS PART NUMBER
	SLL	IPTSIZEOF,A1		;SIZEOF ONE POINT
	ADD	A3,A1			;ADD IN PART OFFSET
	ADDI	IPT0,A1			;ADD IN POINT0 OFFSET
	MOVL	*A1,A14			;GET POINTY:X
	MOVL	*A3(IANIOFF),A1		;GET ANIY:X
	
	;PARTSXY = POINTY:X - ANIY:X
	SUBXY	A1,A14			;FIND DIFF FROM MAIN ANIOFF
	MOVL	A14,*A0(OPARTSXY)
	JRUC	SNSPDONE

SNSPHFLIP
	;REMAP POINT TO KEEP TIRE0 ON FRONT LEFT
	XORI	3,A1			;0<-3, 1<-2, 2<-1, 3<-0

	;GET ANIM POINT CORRESPONDING TO NS PART NUMBER
	SLL	IPTSIZEOF,A1		;SIZEOF ONE POINT
	ADD	A3,A1			;ADD IN PART OFFSET
	ADDI	IPT0,A1			;ADD IN POINT0 OFFSET
	MOVL	*A1,A14			;GET POINTY:X
	MOVL	*A3(IANIOFF),A1		;GET ANIY:X

	;FLIPPED POINTY - ANIY AND ANIX - POINTX
	MOVE	A14,A2
	SUBXY	A1,A14
	SRL	16,A14
	MOVW	A14,*A0(OPARTSXY+10H)
	SUBXY	A2,A1
	MOVW	A1,*A0(OPARTSXY)
	JRUC	SNSPDONE


SNSPNWHEEL
	;SET DIR SAME AS CAR
	MOVW	*A8(ODIR),A2
	MOVW	A2,*A0(ODIR)
	SLL	24,A2
	SRL	24+DIRTOMISINDEX,A2
	SLL	MISIZEOF,A2
	ADDI	MISIMAGES,A2

	MOVL	*A2+,A1 		;IHDR
	MOVL	*A2,A2			;AOFF:CTRL
	MOVE	A2,A3
	ZEXT	A2,W			;CTRL
	ANDNI	M_INUSE,A2		;!!FIX TBL!!
	SRL	16,A3			;AOFF

	;KEEP DMAGO BIT OF OBJ
	MOVW	*A0(OCTRL),A14
	ANDI	M_INUSE,A14
	OR	A14,A2

	;UPDATE IMAGE
	MOVL	A1,*A0(OIMG)			;UPDATE IMAGE
	MOVL	*A1(ISIZE),A14			;Y:X SIZ
	MOVL	A14,*A0(OSIZE)
	MOVL	A14,*A0(OUSIZE)
 	MOVL	*A1(ISAG),A14
	MOVL	A14,*A0(OSAG)			;SAG
  	MOVW	*A1(ICTRL),A14			;GET ICTRL
	OR	A2,A14				;OR IN OUR
  	MOVW	A14,*A0(OCTRL)
	
	;SET ANIM POINT
	ADD	A3,A1				;IHDR+AOFF
	MOVL	*A1,A14				;Y:X ANI
	MOVL	A14,*A0(OANIOFF)
	MOVL	A14,*A0(OUANIOFF)

	CLR	A14			
	MOVW	A14,*A0(OSCALEMUL)		;FORCE UPDATE

	JRUC	SNSX	
	

SNSPDONE
	CLR	A14			
	MOVW	A14,*A0(OSCALEMUL)		;FORCE UPDATE
	
SNSX
	RETS

**
** ADDNSPART
**
** IN
**   A0 OBJ TO ADD IT TO
**   A1 ANIMSCRIPT
**   A2 PART ID
** OUT
**   A2 OBJ OR Z
**
** JFL 24 AUG 92
** JFL 25 SEP 92; NEW SCRATCH
** JFL 29 SEP 92; NEW SCRATCH
** JFL 12 OCT 92; REDONE
** JFL 24 NOV 92
** JFL 07 DEC 92
** JFL 13 JAN 93
**
ADDNSPART
	MMTM	SP,A0,A1,A4,A8

	.IF DEBUG
	CMPI	FIRSTNSPART,A2
	TLOCKON	LO
	.ENDIF ;DEBUG

	;CAN ONLY HANDLE 0..3 FOR NOW
	CMPI	FIRSTNSPART+3,A2
	TLOCKON	HI
	JRHI	ANSPBADX

	MOVE	A0,A8				;A8 OBJ HEAD
	MOVE	A1,A4				;A4 ANIMSCRIPT
	MOVE	A2,A3 				;A3 PART ID
	
	;GET ID & CHECK IF OBJ ALREADY HAS ONE
	;XXX MOVE	A3,A1
	;CALLR	CHECKFORNSPART ;IN: A0,A1 OBJ,PARTNUM
	;JRNZ	ANSPX

	;GET OBJ
	CALLA	GETOBJ
	TLOCKON	Z

	;FILL IN MISC INFO
	MOVW	A3,*A0(OPARTID)
	MOVI	OID_PART,A14
	MOVW	A14,*A0(OID)

	;FILL IN IMAGE DATA
	MOVE	A4,A2
	SLL	SL_HVF,A2			;LINE UP HV FLIP TO CTRL
	SRL	SR_HVF,A2	
	SRL	4,A4				;CLEAR FLAG BITS
	SLL	4,A4
	MOVL	*A4,A1				;A1 IMAGE
	MOVL	A1,*A0(OIMG)			;UPDATE IMAGE
	MOVL	*A1(ISIZE),A14			;Y:X SIZ
	MOVL	A14,*A0(OSIZE)
	MOVL	A14,*A0(OUSIZE)
 	MOVL	*A1(ISAG),*A0(OSAG)		;SAG
	MOVL	*A1(IANIOFF),A14		;Y:X ANI OFF
	MOVL	A14,*A0(OANIOFF)
	MOVL	A14,*A0(OUANIOFF)
  	MOVW	*A1(ICTRL),A14			;GET ICTRL
	ORI	DMAWNZ,A14
	OR	A2,A14
  	MOVW	A14,*A0(OCTRL)

	;USE SAME PALETTE
	PUSH	A0
	MOVL	*A1(ICMAP),A0
	CALLA	GETFPAL
	TLOCKON	Z
	MOVE	A0,A14
	PULL	A0
	MOVW	A14,*A0(OPAL)
				  	
	;SET NON STANDARD PART
	MOVW	*A0(OPARTID),A1
	CALLR	SETNSPONE ;IN: A0,A1,A8 OBJPART,OPARTID,OBJHEAD

	;LINK IN AT END	-- MUST BE AFTER NORMAL CAR PARTS
	MOVL	A8,*A0(OPART1)

	;FIND END OF PARTS
	MOVE	A8,A1
ANSPLINK
	MOVE	A1,A3		 	;A3 PREV
	MOVL	*A1(OPARTS),A1
	JRNZ	ANSPLINK
	
	MOVL	A1,*A0(OPARTS)		;CLR LINK AFTER US
	MOVL	A0,*A3(OPARTS)		;ADD US TO PREV

	;INSERT THE OBJ INTO THE PLANE LIST
	CALLR	INSOBJ

	;ADD ANIMATION
	MOVL	A4,*A0(ANIMFRM)
	MOVL	A4,*A0(ANIMSCR)
	MOVK	1,A14
	MOVW	A14,*A0(ANIMSLPB)
	CALLA	CKINSANI

ANSPX
	MOVE	A0,A2			;RETURN OBJ
	MMFM	SP,A0,A1,A4,A8
	RETS
ANSPBADX	
	CLR	A2
	MMFM	SP,A0,A1,A4,A8
	RETS

